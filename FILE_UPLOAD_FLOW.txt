╔════════════════════════════════════════════════════════════════════════════╗
║                    对话文件上传功能 - 数据流程图                             ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                           1. 用户操作 (前端 UI)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                ┌─────────────────────┴──────────────────────┐
                │                                            │
        ┌───────▼────────┐                         ┌────────▼────────┐
        │  点击上传按钮    │                         │  拖拽文件到区域   │
        └───────┬────────┘                         └────────┬────────┘
                │                                            │
                └─────────────────────┬──────────────────────┘
                                      │
                            ┌─────────▼─────────┐
                            │  选择文件(1-10个) │
                            │  限制: 10MB/文件  │
                            └─────────┬─────────┘
                                      │
┌─────────────────────────────────────┼─────────────────────────────────────┐
│                         2. 文件上传处理 (前端)                              │
└─────────────────────────────────────┼─────────────────────────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  handleFileChange(uploadFile)      │
                    │  - 验证文件大小 (≤10MB)            │
                    │  - 检查文件数量 (≤10)              │
                    │  - 显示上传状态                    │
                    └─────────────────┬──────────────────┘
                                      │
                        ┌─────────────▼─────────────┐
                        │  uploadFiles(files) API   │
                        │  - 创建 FormData          │
                        │  - 设置 Content-Type      │
                        │  - POST /chat/upload-files│
                        └─────────────┬─────────────┘
                                      │
                                      │ HTTP Request
                                      │ (multipart/form-data)
┌─────────────────────────────────────┼─────────────────────────────────────┐
│                      3. 后端接收与处理 (Spring Boot)                        │
└─────────────────────────────────────┼─────────────────────────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  ChatController.uploadFiles()     │
                    │  - 验证用户身份 (JWT Token)        │
                    │  - 检查权限 (API_USE)             │
                    │  - 验证文件数量                    │
                    └─────────────────┬──────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  逐个处理文件:                      │
                    │  processFile(MultipartFile)       │
                    └─────────────────┬──────────────────┘
                                      │
                        ┌─────────────▼─────────────┐
                        │  FileParser.parseFile()   │
                        │  1. 获取文件扩展名         │
                        │  2. 验证文件类型           │
                        │  3. 读取文件内容 (UTF-8)   │
                        │  4. 返回文本内容           │
                        └─────────────┬─────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  内容处理:                          │
                    │  - 检查内容长度                     │
                    │  - 超过100KB则截断                  │
                    │  - 构建 FileUploadResult           │
                    └─────────────────┬──────────────────┘
                                      │
                                      │ HTTP Response
                                      │ List<FileUploadResult>
┌─────────────────────────────────────┼─────────────────────────────────────┐
│                      4. 前端接收结果与展示                                  │
└─────────────────────────────────────┼─────────────────────────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  处理上传结果:                      │
                    │  - 检查 success 标志               │
                    │  - 成功: 添加到 uploadedFiles[]    │
                    │  - 失败: 显示错误消息              │
                    └─────────────────┬──────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  UI 更新:                          │
                    │  - 显示文件标签 (el-tag)           │
                    │  - 显示文件名和大小                │
                    │  - 提供删除按钮                    │
                    └─────────────────┬──────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  用户可以:                         │
                    │  - 继续上传更多文件                │
                    │  - 删除不需要的文件                │
                    │  - 输入文本消息                    │
                    │  - 点击发送按钮                    │
                    └─────────────────┬──────────────────┘
                                      │
┌─────────────────────────────────────┼─────────────────────────────────────┐
│                      5. 消息发送处理                                        │
└─────────────────────────────────────┼─────────────────────────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  sendMessage()                     │
                    │  构建完整消息:                      │
                    │                                    │
                    │  [用户输入的文本]                   │
                    │                                    │
                    │  --- 附件内容 ---                  │
                    │                                    │
                    │  【文件: file1.txt】               │
                    │  [文件1内容]                       │
                    │                                    │
                    │  【文件: file2.py】                │
                    │  [文件2内容]                       │
                    └─────────────────┬──────────────────┘
                                      │
                                      │ POST /chat/send
                                      │ ChatRequestDTO
┌─────────────────────────────────────┼─────────────────────────────────────┐
│                      6. 后端消息处理与AI调用                                │
└─────────────────────────────────────┼─────────────────────────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  ChatService.sendMessage()        │
                    │  - 保存用户消息(含文件内容)        │
                    │  - 构建消息历史                    │
                    │  - 调用 AI API                    │
                    │  - 保存 AI 回复                   │
                    │  - 更新用户配额                    │
                    └─────────────────┬──────────────────┘
                                      │
                        ┌─────────────▼─────────────┐
                        │  AiApiClient.callAiApi()  │
                        │  发送完整上下文给 AI:      │
                        │  - 系统消息 (可选)         │
                        │  - 历史对话               │
                        │  - 当前消息 (含文件内容)   │
                        └─────────────┬─────────────┘
                                      │
                                      │ AI 模型处理
                                      │ 基于文件内容理解
                                      │
                                      ▼
                        ┌─────────────────────────┐
                        │  AI 返回智能回复        │
                        │  - 理解文件内容         │
                        │  - 回答用户问题         │
                        │  - 提供分析建议         │
                        └─────────────┬───────────┘
                                      │
                                      │ HTTP Response
                                      │
┌─────────────────────────────────────┼─────────────────────────────────────┐
│                      7. 前端展示结果                                        │
└─────────────────────────────────────┼─────────────────────────────────────┘
                                      │
                    ┌─────────────────▼──────────────────┐
                    │  - 清空已上传文件列表               │
                    │  - 重新加载会话消息                │
                    │  - 显示 AI 回复 (Markdown渲染)     │
                    │  - 更新 API 使用量                 │
                    │  - 滚动到最新消息                  │
                    └────────────────────────────────────┘


╔════════════════════════════════════════════════════════════════════════════╗
║                           关键技术点总结                                    ║
╠════════════════════════════════════════════════════════════════════════════╣
║                                                                            ║
║  🔐 安全验证: JWT Token + 权限控制 + 文件类型验证                            ║
║  📊 资源限制: 10MB/文件, 10个文件, 100KB内容                                ║
║  🔄 异步处理: 不阻塞UI, 独立处理每个文件                                     ║
║  📝 智能合并: 用户输入 + 文件内容 → 完整上下文                               ║
║  🎨 用户体验: 拖拽上传 + 实时反馈 + 可视化管理                               ║
║  🚀 性能优化: 内容截断 + 状态缓存 + 错误恢复                                 ║
║                                                                            ║
╚════════════════════════════════════════════════════════════════════════════╝
